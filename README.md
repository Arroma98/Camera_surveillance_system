# Camera_surveillance_system
Surveillance system operated by Node Red

_Under development_

##### [Node Red](https://nodered.org/)
##### Personally I use [Reolink](https://reolink.com/) cameras, having people and vehicle recognition.
###### The other cameras I tried, like the TP-Link, use their own server to process the images, so the intelligent recognition stops working as soon as I block their internet access

#### As a conditional for the trigger I use non-presence at home, which I obtain thanks to the IP of the device with a fixed MAC address
As a result, in the configuration.yaml I have:
```
device_tracker:
  - platform: ping
    hosts:
      person1: !secret person1_ip
    consider_home: 100
    interval_seconds: 10
```
###### You can use this directly, or, if you want more control, you can interact it with an input_boolean

![immagine nodo](node.jpg)

```
[{"id":"4879e8e3cf01b3d5","type":"trigger-state","z":"4c716a532f554ef5","name":"Person1 at home","server":"","version":2,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfiltertype":"exact","debugenabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"bool","comparatorValue":"true"}],"inputs":0,"outputs":2,"customoutputs":[],"outputinitially":false,"state_type":"habool","enableInput":false,"x":700,"y":640,"wires":[[],["58e2063bc8e27370"]]},{"id":"6285290d5d5a4108","type":"inject","z":"4c716a532f554ef5","name":"At 1pm activate the alerts","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"00 13 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":660,"y":600,"wires":[["58e2063bc8e27370"]]},{"id":"58e2063bc8e27370","type":"api-call-service","z":"4c716a532f554ef5","name":"","server":"","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.boolean"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":920,"y":640,"wires":[[]]},{"id":"a541fe4cbe54f3a4","type":"inject","z":"4c716a532f554ef5","name":"timestamp","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"*/5 0-5 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":470,"y":680,"wires":[["15fcd250a44eee1f"]]},{"id":"15fcd250a44eee1f","type":"time-range-switch","z":"4c716a532f554ef5","name":"Check that it's bed time","lat":"","lon":"","startTime":"00:00","endTime":"05:00","startOffset":0,"endOffset":0,"x":670,"y":680,"wires":[["58e2063bc8e27370"],[]]}]
```
____
To receive the notification with sound even if in silent, I play with sensor.ringer_mode
###### (sensor that can be activated in the companion app settings)

![immagine nodo](notify.jpg)

```
[{"id":"20eefc769f3bca41","type":"inject","z":"4c716a532f554ef5","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":180,"y":660,"wires":[["59ca3e51f75375a7","33152b1bc0a9a91c"]]},{"id":"f71e97cdc0c02c70","type":"group","z":"4c716a532f554ef5","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["f7dc3e416c1b2e87","d18d40a53261c5d7","dab13fc387c9c28d","2ac1f6da0bd08d8b","9105b3aced88dc3a","e2ded0e23adeb30f","b9d8126e6f50b6fd","2f80aa91237ffd7c","8b880429eb88a036","59ca3e51f75375a7","33152b1bc0a9a91c","75c0b56e0cfa816c"],"x":274,"y":539,"w":672,"h":242},{"id":"f7dc3e416c1b2e87","type":"api-call-service","z":"4c716a532f554ef5","g":"f71e97cdc0c02c70","name":"Notify","server":"","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone","areaId":[],"deviceId":[],"entityId":[],"data":"{\t   \"message\":\"Someone detected\",\t   \"title\":\"Alarm\",\t   \"data\":{\t        \"group\": \"Surveillance\"\t   }\t}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":850,"y":740,"wires":[[]]},{"id":"d18d40a53261c5d7","type":"api-call-service","z":"4c716a532f554ef5","g":"f71e97cdc0c02c70","name":"normal mode","server":"","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone","areaId":[],"deviceId":[],"entityId":[],"data":"{\t   \"message\":\"command_ringer_mode\",\t   \"data\": {\t        \"command\":\"normal\"\t   }\t}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":510,"y":740,"wires":[["dab13fc387c9c28d"]]},{"id":"dab13fc387c9c28d","type":"delay","z":"4c716a532f554ef5","g":"f71e97cdc0c02c70","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":710,"y":740,"wires":[["f7dc3e416c1b2e87"]]},{"id":"2ac1f6da0bd08d8b","type":"api-current-state","z":"4c716a532f554ef5","g":"f71e97cdc0c02c70","name":"vibrate?","server":"","version":3,"outputs":2,"halt_if":"vibrate","halt_if_type":"str","halt_if_compare":"is","entity_id":"sensor.opandrea_ringer_mode_12","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":500,"y":660,"wires":[["9105b3aced88dc3a"],[]]},{"id":"9105b3aced88dc3a","type":"delay","z":"4c716a532f554ef5","g":"f71e97cdc0c02c70","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":680,"y":660,"wires":[["e2ded0e23adeb30f"]]},{"id":"e2ded0e23adeb30f","type":"api-call-service","z":"4c716a532f554ef5","g":"f71e97cdc0c02c70","name":"vibrate again","server":"","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone","areaId":[],"deviceId":[],"entityId":[],"data":"{\t   \"message\":\"command_ringer_mode\",\t   \"data\": {\t        \"command\":\"vibrate\"\t   }\t}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":830,"y":660,"wires":[[]]},{"id":"b9d8126e6f50b6fd","type":"api-current-state","z":"4c716a532f554ef5","g":"f71e97cdc0c02c70","name":"silent?","server":"","version":3,"outputs":2,"halt_if":"silent","halt_if_type":"str","halt_if_compare":"is","entity_id":"sensor.opandrea_ringer_mode_12","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":490,"y":700,"wires":[["2f80aa91237ffd7c"],[]]},{"id":"2f80aa91237ffd7c","type":"delay","z":"4c716a532f554ef5","g":"f71e97cdc0c02c70","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":700,"y":700,"wires":[["8b880429eb88a036"]]},{"id":"8b880429eb88a036","type":"api-call-service","z":"4c716a532f554ef5","g":"f71e97cdc0c02c70","name":"silent again","server":"","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone","areaId":[],"deviceId":[],"entityId":[],"data":"{\t   \"message\":\"command_ringer_mode\",\t   \"data\": {\t        \"command\":\"silent\"\t   }\t}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":850,"y":700,"wires":[[]]},{"id":"59ca3e51f75375a7","type":"api-call-service","z":"4c716a532f554ef5","g":"f71e97cdc0c02c70","name":"sensor update","server":"","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone","areaId":[],"deviceId":[],"entityId":[],"data":"{\t   \"message\":\"command_update_sensors\"\t}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":380,"y":620,"wires":[[]]},{"id":"33152b1bc0a9a91c","type":"delay","z":"4c716a532f554ef5","g":"f71e97cdc0c02c70","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":360,"y":700,"wires":[["b9d8126e6f50b6fd","2ac1f6da0bd08d8b","d18d40a53261c5d7"]]},{"id":"75c0b56e0cfa816c","type":"comment","z":"4c716a532f554ef5","g":"f71e97cdc0c02c70","name":"Person1","info":"","x":360,"y":580,"wires":[]}]
```
____
#### Arm the alarm when everyone leaves home.
![nodo_img](nodo_img.png)
```
[{"id":"9fd53316798a2062","type":"trigger-state","z":"c7248b1f7d1e034f","g":"f36233b8c7ff738e","name":"Family group","server":"84316002.41205","version":2,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityid":"group.famiglia","entityidfiltertype":"exact","debugenabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"bool","comparatorValue":"true"}],"inputs":0,"outputs":2,"customoutputs":[],"outputinitially":false,"state_type":"habool","enableInput":false,"x":270,"y":1840,"wires":[[],["d17f691b38bc4e2b"]]},{"id":"d17f691b38bc4e2b","type":"api-current-state","z":"c7248b1f7d1e034f","g":"f36233b8c7ff738e","name":"At home?","server":"84316002.41205","version":3,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","entity_id":"group.famiglia","state_type":"habool","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":420,"y":1840,"wires":[["6da405ca236c5c19"],["f813ae308bf9ce7b"]]},{"id":"6da405ca236c5c19","type":"api-current-state","z":"c7248b1f7d1e034f","g":"f36233b8c7ff738e","name":"Armed?","server":"84316002.41205","version":3,"outputs":2,"halt_if":"disarmed","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"alarm_control_panel.allarme_casa","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":560,"y":1820,"wires":[["11034f5d96d41c8e"],[]]},{"id":"f813ae308bf9ce7b","type":"delay","z":"c7248b1f7d1e034f","g":"f36233b8c7ff738e","name":"","pauseType":"delay","timeout":"10","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":570,"y":1860,"wires":[["36f6dfce4fb19dbc"]]},{"id":"36f6dfce4fb19dbc","type":"api-call-service","z":"c7248b1f7d1e034f","g":"f36233b8c7ff738e","name":"Arm away","server":"84316002.41205","version":5,"debugenabled":false,"domain":"alarm_control_panel","service":"alarm_arm_away","areaId":[],"deviceId":[],"entityId":["alarm_control_panel.allarme_casa"],"data":"{\"code\":\"!secret alarm_code\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":720,"y":1860,"wires":[[]]},{"id":"11034f5d96d41c8e","type":"api-call-service","z":"c7248b1f7d1e034f","g":"f36233b8c7ff738e","name":"Arm home","server":"84316002.41205","version":5,"debugenabled":false,"domain":"alarm_control_panel","service":"alarm_arm_home","areaId":[],"deviceId":[],"entityId":["alarm_control_panel.allarme_casa"],"data":"{\"code\":\"!secret alarm_code\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":730,"y":1820,"wires":[[]]},{"id":"84316002.41205","type":"server","name":"Home Assistant","version":5,"addon":true,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true,"cacheJson":true,"heartbeat":false,"heartbeatInterval":30,"areaSelector":"friendlyName","deviceSelector":"friendlyName","entitySelector":"friendlyName","statusSeparator":"at: ","statusYear":"hidden","statusMonth":"short","statusDay":"numeric","statusHourCycle":"h23","statusTimeFormat":"h:m","enableGlobalContextStore":true}]
```
____
#### Telegram media
![telegram](tg_nodo.png)
```
[{"id":"9e353cb5b6ca85a9","type":"delay","z":"4c716a532f554ef5","g":"31609148d5447ca9","name":"Every 1 minute","pauseType":"rate","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"60","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":440,"y":960,"wires":[["f9a94883ead1448b","b2d999b9dbbca1d4"]]},{"id":"f9a94883ead1448b","type":"api-call-service","z":"4c716a532f554ef5","g":"31609148d5447ca9","name":"Snapshot","server":"84316002.41205","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":[],"data":"{\"filename\":\"/config/www/camera/snapshot.jpeg\"}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":600,"y":940,"wires":[["142907d78e9e3b0d"]]},{"id":"b2d999b9dbbca1d4","type":"api-call-service","z":"4c716a532f554ef5","g":"31609148d5447ca9","name":"15s record","server":"84316002.41205","version":5,"debugenabled":false,"domain":"camera","service":"record","areaId":[],"deviceId":[],"entityId":[],"data":"{\"filename\":\"/config/www/camera/record.mp4\",\"duration\":\"15\"}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":610,"y":980,"wires":[["c8125ddb576a2269"]]},{"id":"142907d78e9e3b0d","type":"delay","z":"4c716a532f554ef5","g":"31609148d5447ca9","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":770,"y":940,"wires":[["5d5a6362d21a1da7"]]},{"id":"c8125ddb576a2269","type":"delay","z":"4c716a532f554ef5","g":"31609148d5447ca9","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":770,"y":980,"wires":[["40aa646771247cd5"]]},{"id":"5d5a6362d21a1da7","type":"api-call-service","z":"4c716a532f554ef5","g":"31609148d5447ca9","name":"TG snapshot","server":"84316002.41205","version":5,"debugenabled":false,"domain":"telegram_bot","service":"send_photo","areaId":[],"deviceId":[],"entityId":[],"data":"{\"file\":\"/config/www/camera/snapshot.jpeg\",\"caption\":\"<Name>\",\"target\":\"<chat_id>\"}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":930,"y":940,"wires":[[]]},{"id":"40aa646771247cd5","type":"api-call-service","z":"4c716a532f554ef5","g":"31609148d5447ca9","name":"TG record","server":"84316002.41205","version":5,"debugenabled":false,"domain":"telegram_bot","service":"send_video","areaId":[],"deviceId":[],"entityId":[],"data":"{\"file\":\"/config/www/camera/record.mp4\",\"caption\":\"<Name>\",\"target\":\"<chat_id>\"}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":940,"y":980,"wires":[[]]},{"id":"84316002.41205","type":"server","name":"Home Assistant","version":5,"addon":true,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true,"cacheJson":true,"heartbeat":false,"heartbeatInterval":30,"areaSelector":"friendlyName","deviceSelector":"friendlyName","entitySelector":"friendlyName","statusSeparator":"at: ","statusYear":"hidden","statusMonth":"short","statusDay":"numeric","statusHourCycle":"h23","statusTimeFormat":"h:m","enableGlobalContextStore":true}]
```
____

### Text To Speach and lovelace opening of video surveillance
![TTS](speak_nodo.png)
```
[{"id":"857dc0dc25f43af6","type":"api-current-state","z":"4c716a532f554ef5","name":"CTRL boolean","server":"84316002.41205","version":3,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","entity_id":"input_boolean.","state_type":"habool","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1780,"y":1140,"wires":[["f4347a8c7476a1ce","81bfa1d018fcf7a1"],[]]},{"id":"f4347a8c7476a1ce","type":"api-call-service","z":"4c716a532f554ef5","name":"Open lovelace","server":"84316002.41205","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_opandrea","areaId":[],"deviceId":[],"entityId":[],"data":"{\t   \"message\":\"command_webview\",\t   \"data\": {\t        \"command\": \"/lovelace/webcam\"\t   }\t}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1980,"y":1120,"wires":[[]]},{"id":"81bfa1d018fcf7a1","type":"api-call-service","z":"4c716a532f554ef5","name":"TTS","server":"84316002.41205","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_opandrea","areaId":[],"deviceId":[],"entityId":[],"data":"{\t   \"message\":\"TTS\",\t   \"data\":{\t        \"tl\": \"0\",\t        \"priority\": \"high\",\t        \"media_stream\": \"alarm_stream_max\",\t        \"tts_text\": \"<message>\"\t   }\t}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1950,"y":1160,"wires":[[]]},{"id":"84316002.41205","type":"server","name":"Home Assistant","version":5,"addon":true,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true,"cacheJson":true,"heartbeat":false,"heartbeatInterval":30,"areaSelector":"friendlyName","deviceSelector":"friendlyName","entitySelector":"friendlyName","statusSeparator":"at: ","statusYear":"hidden","statusMonth":"short","statusDay":"numeric","statusHourCycle":"h23","statusTimeFormat":"h:m","enableGlobalContextStore":true}]
```
